version: '3.8'

services:
  # PostgreSQL - Primary database
  postgres:
    image: postgres:16-alpine
    container_name: eventflow-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=eventflow
      - POSTGRES_USER=eventflow
      - POSTGRES_PASSWORD=eventflow_dev_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U eventflow"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - eventflow

  # NATS - Event message queue
  nats:
    image: nats:2.10-alpine
    container_name: eventflow-nats
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # HTTP monitoring
    command: ["-js", "-m", "8222"]  # Enable JetStream + monitoring
    networks:
      - eventflow

  # API - REST API for managing functions
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: eventflow-api
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      - PORT=8080
      - NAMESPACE=default
      - JWT_SECRET=dev-secret-change-in-production
      - LOG_LEVEL=info
      - NATS_URL=nats://nats:4222
      - DATABASE_URL=postgres://eventflow:eventflow_dev_password@postgres:5432/eventflow?sslmode=disable
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - eventflow

  # Dispatcher - Consumes events and invokes functions
  dispatcher:
    build:
      context: ./dispatcher
      dockerfile: Dockerfile
    container_name: eventflow-dispatcher
    environment:
      - NATS_URL=nats://nats:4222
      - LOG_LEVEL=info
    depends_on:
      - nats
    networks:
      - eventflow

  # Web Dashboard
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: eventflow-web
    ports:
      - "3000:80"
    depends_on:
      - api
    networks:
      - eventflow

networks:
  eventflow:
    driver: bridge

volumes:
  postgres_data:
    driver: local
